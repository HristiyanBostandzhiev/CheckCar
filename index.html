<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка на регистрационен номер</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Проверка на регистрационен номер</h1>
        <form id="checkForm">
            <label for="plate">Регистрационен номер (само латински букви и цифри):</label>
            <input type="text" name="plate" id="plate" required>
            <button type="submit">Провери</button>
        </form>
        <div class="result" id="resultDiv">
            <!-- Резултатите ще бъдат изведени тук -->
        </div>
    </div>

    <script>
        function is_valid_input(input_str) {
            // Проверка за валидност на входните данни (само латински букви и цифри)
            return /^[a-zA-Z0-9]+$/.test(input_str);
        }

        function generate_random_email() {
            // Генериране на случаен email с формат something@gmail.com
            var random_word = Math.random().toString(36).substring(2, 10);
            return random_word + "@gmail.com";
        }

        function get_data_from_api(url, payload) {
            // Изпращане на POST заявка към API и връщане на отговора в JSON формат
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json());
        }

        document.getElementById('checkForm').addEventListener('submit', function(event) {
            event.preventDefault();
            var plateNumber = document.getElementById('plate').value;

            // Проверка за валидност на регистрационния номер
            if (!is_valid_input(plateNumber)) {
                document.getElementById('resultDiv').innerHTML = '<p class="error">Грешка: Позволени са само латински букви и цифри.</p>';
            } else {
                // Генериране на случаен email
                var email = generate_random_email();

                // Заявка към първото API - гражданска отговорност
                var payload1 = { email: email, plate: plateNumber };
                get_data_from_api('https://myve.bg:4402/check/get/zastrahovka', payload1)
                    .then(function(response1) {
                        var resultHtml = '';
                        if (response1.data === "no info") {
                            resultHtml += '<p>Гражданска отговорност до: Няма валидна гражданска отговорност</p>';
                        } else {
                            var big_data = response1.data.big_data || [];
                            if (big_data.length > 0) {
                                var valid_to = big_data[0][2];
                                resultHtml += '<p>Гражданска отговорност до: ' + valid_to + '</p>';
                            } else {
                                resultHtml += '<p>Гражданска отговорност до: Няма информация за гражданска отговорност</p>';
                            }
                        }

                        // Заявка към второто API - технически преглед
                        var payload2 = { email: email, plate: plateNumber };
                        return get_data_from_api('https://myve.bg:4402/check/get/gtp', payload2)
                            .then(function(response2) {
                                if (response2.data) {
                                    var technical_inspection_data = response2.data;
                                    var valid_to_match = /валиден до\n\n(\d{2}\.\d{2}\.\d{4})/.exec(technical_inspection_data);
                                    var valid_to = valid_to_match ? valid_to_match[1] : null;
                                    if (valid_to) {
                                        resultHtml += '<p>Технически преглед до: ' + valid_to + '</p>';
                                    } else {
                                        resultHtml += '<p>Технически преглед до: Няма данни за валиден технически преглед!</p>';
                                    }
                                } else {
                                    resultHtml += '<p>Технически преглед до: Няма информация за технически преглед</p>';
                                }

                                // Заявка към третото API - винетка
                                var payload3 = { email: email, plate: plateNumber };
                                return get_data_from_api('https://myve.bg:4402/check/get/vinetka', payload3)
                                    .then(function(response3) {
                                        if (response3.data === "no info") {
                                            resultHtml += '<p>Винетка до: Съжаляваме, но не беше открита активна винетка.</p>';
                                        } else {
                                            var valid_to = response3.data.valid_to;
                                            if (valid_to) {
                                                resultHtml += '<p>Винетка до: ' + valid_to + '</p>';
                                            } else {
                                                resultHtml += '<p>Винетка до: Няма информация за винетка</p>';
                                            }
                                        }

                                        document.getElementById('resultDiv').innerHTML = resultHtml;
                                    });
                            });
                    })
                    .catch(function(error) {
                        document.getElementById('resultDiv').innerHTML = '<p>Грешка при извличане на данни: ' + error + '</p>';
                    });
            }
        });
    </script>
</body>
</html>
